#include <stdlib.h>
#include <stdio.h>
#include <string.h>

/* convert hex char to dec */
int hex_char2int(char input){
	int result = 0;
	if((int)input>47 && (int)input<58)
		result = (int)input-48;
	else if((int)input>96 && (int)input<104)
		result = (int)input-97+10;
	else
		result = 0;
	return result;
}

/* Calculate socres for message m, scores are corresponding to English word frequencies*/
int cal_scores(char* m, int len){
	/*scores for letters (Converted from float to int)*/
	int scores[] = {817, 149, 278, 425, 1270, 222, 201, 609, 696, 15, 77, 402, 240, 670, 750, 192, 9, 598, 632, 905, 275, 97, 236, 15, 197, 7};
	int result[26];
	float final = 0;
	int num = 0;
	
	/* Reset result array */
	for(int i=0; i<26; i++) result[i]=0;

	/* Calculate score for each letter*/
	for(int i=0; i<len; i++){
		if(m[i]>64 && m[i]<91)
			result[m[i]-65]++;
		else if(m[i]>96 && m[i]<123)
			result[m[i]-97]++;
		/* rule out meaningless characters */
		//else if((m[i]>33 && m[i]<48) || (m[i] >57 && m[i]<65))
		//	return 0;
	}
	
	/* Accumulate final score */
	for(int i=0; i<26; i++){
		if(result[i]==0)
			continue;
		final += (scores[i] / result[i]);
		num++;
	}
	return final*num;
}

void exploit(char* cipher, int len){
	//printf("Cipher: %s\n", cipher);
	int scores[128];
	char messages[128][len/2]; // 128 answers, each one has 60 chars

	/* for each cipher in the txt file */
	for(int i=0; i<128; i++){
		char result[len];
		
		/* for each cipher character */
		for(int j=0; j<len; j+=2){
			int temp = hex_char2int(cipher[j]);
			temp = temp << 4;
			temp += hex_char2int(cipher[j+1]);
			result[j/2] = (char)temp^i;
		}
			
		scores[i] = cal_scores(result, len/2);
		//printf("%d\n", scores[i]);
		memcpy(messages[i], result, len/2);
	}	
	
	for(int i=0; i<128; i++)
		for(int j=i; j<128; j++)
			if(scores[i] < scores[j]){
				int temp1 = scores[i];
				scores[i] = scores[j];
				scores[j] = temp1;
				char temp2[len/2];
			       	memcpy(temp2, messages[i], len/2);
				memcpy(messages[i], messages[j], len/2);
				memcpy(messages[j], temp2, len/2);
			}

	FILE* fp;
	fp = fopen("scores", "ab");
	fwrite(scores, sizeof(int), 10, fp);
	fclose(fp);
	fp = fopen("messages", "ab");
	fwrite(messages, sizeof(char)*len/2, 10, fp);
	fclose(fp);
}

void read_result(int len, int num){
	FILE* fp;
	int scores[num*10];
	char messages[num*10][len/2]; // 128 answers, each one has 60 chars
	fp = fopen("scores", "rb");
	fread(scores, sizeof(int), num*10, fp);
	fclose(fp);
	fp = fopen("messages", "rb");
	fread(messages, sizeof(char)*len/2, num*10, fp);
	
	/* sort scores from high to low */ 
	for(int i=0; i<num*10; i++)
		for(int j=i; j<num*10; j++)
			if(scores[i] < scores[j]){
				int temp1 = scores[i];
				scores[i] = scores[j];
				scores[j] = temp1;
				char temp2[len/2];
			       	memcpy(temp2, messages[i], len/2);
				memcpy(messages[i], messages[j], len/2);
				memcpy(messages[j], temp2, len/2);
			}

	for(int i=0; i<num*10; i++){
		printf("%d\t", scores[i]);
		for(int j=0; j<len/2; j++)
			printf("%c", messages[i][j]);
		printf("\n");
	}
	remove("scores");
	remove("messages");
}

/* Brute Force*/
int main(int argc, char** argv){
	if(argc!=3){
		printf("Illegal Argument!\n");
		exit(-1);
	}

	/* select between source type (file or message)*/
	if(!strcmp(argv[1],"-f"))
		goto FILE_OP;
	else if(!strcmp(argv[1],"-m"))
		goto MESSAGE_OP;
	else{
		printf("Illegal Arguments!\n");
		exit(-1);
	}
	
	FILE* fp;
	char* filename;
	char* cipher;
	size_t len;
	int i;

	/*Answer: Now that party is jumping*/
	FILE_OP:
	i = 0;
	filename = argv[2];
	
	if(!(fp = fopen(filename, "r")))
		exit(-1);
	/* we should try to avoid using fscanf which may cause buffer overflow*/
	while(getline(&cipher, &len, fp)!=-1){
	//	printf("%s", cipher);// notice cipher has "\n" except for the last line
		exploit(cipher, strlen(cipher)-1);
	//	printf("<%d>\n", i);
		i++;
	}
	read_result(strlen(cipher), i);
	printf("\n");
	fclose(fp);
	return 0;
	
	MESSAGE_OP:
	cipher = argv[2];
	len = strlen(cipher);
	exploit(cipher, strlen(cipher));
	read_result(strlen(cipher), 1);	
	//for(int i=0; i<10; i++){
	//	if(ans[i]->score < 80000)// not English words
	//		continue;
	//	printf("%d\t", ans[i]->score);
	//	for(int j=0; j<34; j++)
	//		printf("%c", (ans[i]->message)[j]);
	//	printf("\n");
	//}
	return 0;
}


