#include<stdio.h>
#include<stdlib.h>
#include<string.h>

/* Calculate the hamming distance between two strings m1 and m2 (m1 and m2 have the same length) */
int hamming_distance(int m1, int m2){
	int result = 0;
	int temp = m1^m2; // XOR operation
	/* Calculating the number of 1s in temp*/
	for(int j=0; j<8; j++)
		result += (temp>>j)&1;

	return result;
}

/* Convert base64 char to int */
int base64_char2int(char m){
	int result;
	if(m>=65 && m<=90)
		result = m-65;
	else if(m>=97 && m<=122)
		result = m+26-97;
	else if(m>=48 && m<=57)
		result = m+52-48;
	else if(m == 43)
		result = 62;
	else if(m == 47)
		result = 63;
	return result;
}

/* Get the possible key length */
int get_key_len(char* m, int keysize_min, int keysize_max){
	
	float result[keysize_max-keysize_min+1];

	for(int i=0; i<(keysize_max-keysize_min+1); i++)
		result[i] = 0;
	
	/* For every possible key.. calculate its score*/
	for(int i=keysize_min; i<=keysize_max; i++){
		for(int j=0; j<i; j++)
			result[i-keysize_min] += hamming_distance(base64_char2int(m[j]), base64_char2int(m[i+j]));
		//printf("%d\t%.2f\t%.2f\n", i, result[i-keysize_min], result[i-keysize_min]/(float)i);
	}
	
	/* Simple sort algorithm */
	int min = result[0];
	int keysize = 0;
	for(int i=0; i<(keysize_max-keysize_min+1); i++)
		if(result[i]<min){
			keysize = i+keysize_min;
			min = result[i];
		}
	// printf("Keysize: %d\n", keysize);	
	return keysize;
}

/* single byte xor scores calculating*/
int cal_scores(char*m, int len){
	int result[26];
	int final = 0;

	for(int i=0; i<len; i++) result[i]=0;
}

void main(){

	/* Guessing key size from 2 to 40 */
	int keysize = 0;
	char buffer[68];
	
	FILE* fp;
	fp = fopen("xor_cipher_repeating_exploit.txt", "r");


	while(fgets(buffer, 68, fp)!=NULL){
		/* Calculating the keysize for each ciphertext */
		if(keysize==0){
			printf("Guessing keysize...");
			keysize = get_key_len(buffer, 2, 40);
			printf("Done (Keysize: %d)\n", keysize);
		}
		/* cut the ciphertext into keysize blocks
		 * And then sovlev the problem as the single byte xor
		 * */
		
		break;
		// printf("%s", buffer);
	}
	
	//char m1[] = "this is a test";
	//char m2[] = "wokka wokka!!!";
	//int result = 0;
	//for(int i=0; i<strlen(m1); i++){
	//	result += hamming_distance(m1[i], m2[i]);
	//	printf("Distance: %d\n", result);
	//}
}
